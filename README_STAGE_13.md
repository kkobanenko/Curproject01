# Этап 13: Apache Superset - Дашборды

## Обзор

Этап 13 реализует полноценную систему дашбордов для визуализации метрик RAG платформы с использованием Apache Superset. Созданы три специализированных дашборда для мониторинга качества, производительности и использования системы.

## Реализованные компоненты

### 1. Настройка Superset

**Файл:** `infra/superset/Dockerfile`

#### Обновления:
- Установка ClickHouse драйвера (`clickhouse-connect`)
- Копирование скриптов инициализации
- Настройка для работы с метриками RAG

**Файл:** `infra/superset/superset_config.py`

#### Конфигурация:
- Базовые настройки безопасности
- Настройки кэширования
- Включение продвинутых функций
- Оптимизация подключений к БД

### 2. Подключение к ClickHouse

**Файл:** `infra/superset/bootstrap/init_superset.py`

#### Функциональность:
- **Создание подключения к ClickHouse:**
  - URI: `clickhouse://default@clickhouse:8123/rag`
  - Настройка для работы с метриками
  - Поддержка асинхронных запросов

- **Создание источников данных:**
  - `system_metrics` - системные метрики производительности
  - `search_quality_metrics` - метрики качества поиска
  - `resource_usage_metrics` - метрики использования ресурсов
  - `search_metrics` - метрики поисковых запросов
  - `chat_metrics` - метрики чат-сессий
  - `alerts` - система алертов
  - `api_metrics` - метрики API запросов

- **Определение колонок:**
  - Автоматическое создание колонок для каждой таблицы
  - Типы данных и описания
  - Настройка для визуализации

### 3. Дашборд качества RAG

**Файл:** `infra/superset/bootstrap/create_dashboards.py`

#### Чарты:
1. **Средние метрики качества по времени:**
   - Линейный график трендов
   - Метрики: релевантность, точность, полнота, F1-мера
   - Временная шкала для анализа изменений

2. **Распределение качества ответов:**
   - Гистограмма распределения
   - Анализ качества ответов
   - 20 интервалов для детального анализа

3. **Качество поиска по тенантам:**
   - Столбчатая диаграмма
   - Сравнение F1-меры между тенантами
   - Выявление проблемных тенантов

4. **Корреляция метрик качества:**
   - Тепловая карта корреляций
   - Анализ связей между метриками
   - Выявление зависимостей

### 4. Дашборд производительности

#### Чарты:
1. **Использование CPU по сервисам:**
   - Линейный график по времени
   - Мониторинг загрузки CPU
   - Сравнение между сервисами

2. **Использование памяти:**
   - Областная диаграмма
   - Тренды использования памяти
   - Выявление утечек памяти

3. **Время ответа API:**
   - Линейный график по эндпоинтам
   - Мониторинг производительности API
   - Выявление медленных эндпоинтов

4. **Активные соединения:**
   - Столбчатая диаграмма
   - Количество соединений по сервисам
   - Мониторинг нагрузки

5. **Коды ответов API:**
   - Круговая диаграмма
   - Распределение HTTP кодов
   - Анализ ошибок

### 5. Дашборд использования

#### Чарты:
1. **Объем поисковых запросов:**
   - Линейный график по времени
   - Количество запросов
   - Анализ активности пользователей

2. **Популярные поисковые запросы:**
   - Таблица топ-20 запросов
   - Анализ популярности
   - Выявление трендов

3. **Активность по тенантам:**
   - Столбчатая диаграмма
   - Сравнение активности
   - Анализ использования

4. **Статистика чат-сессий:**
   - Линейный график сессий и сообщений
   - Мониторинг чат-активности
   - Анализ взаимодействий

5. **Успешность запросов:**
   - Круговая диаграмма
   - Соотношение успешных/неуспешных
   - Анализ надежности

### 6. Система пользователей и прав

**Файл:** `infra/superset/bootstrap/setup_user.py`

#### Пользователи:
- **rag_admin** - администратор системы
  - Пароль: `rag_admin_password`
  - Полные права на все дашборды
  - Управление источниками данных

#### Роли:
- **RAG_Admin** - полные права:
  - Чтение, запись, удаление дашбордов
  - Управление чартами и источниками данных
  - Доступ к SQL Lab
  - Администрирование пользователей

- **RAG_Viewer** - права только на чтение:
  - Просмотр дашбордов
  - Чтение источников данных
  - Экспорт данных

### 7. Автоматическая инициализация

**Файл:** `infra/superset/bootstrap/init_all.py`

#### Процесс инициализации:
1. **Ожидание готовности БД** - проверка подключения
2. **Запуск скриптов** - последовательное выполнение:
   - `init_superset.py` - создание подключений и источников
   - `create_dashboards.py` - создание дашбордов и чартов
   - `setup_user.py` - настройка пользователей и прав

#### Docker Compose интеграция:
- **superset-init** - контейнер инициализации
- **superset** - основной контейнер
- Автоматический запуск после инициализации

## Технические детали

### Архитектура дашбордов

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   ClickHouse    │───▶│   Superset       │───▶│   Дашборды      │
│   (Метрики)     │    │   (Источники)    │    │   (Визуализация)│
└─────────────────┘    └──────────────────┘    └─────────────────┘
```

### Типы визуализаций

1. **Временные ряды:**
   - Линейные графики для трендов
   - Областные диаграммы для накопления
   - Анализ изменений во времени

2. **Сравнительные:**
   - Столбчатые диаграммы
   - Круговые диаграммы
   - Сравнение между группами

3. **Корреляционные:**
   - Тепловые карты
   - Анализ связей
   - Выявление зависимостей

4. **Распределения:**
   - Гистограммы
   - Анализ частот
   - Статистические распределения

### Оптимизация производительности

- **Кэширование:** Настройка кэша для быстрого доступа
- **Индексы:** Использование индексов ClickHouse
- **Агрегация:** Материализованные представления
- **Фильтрация:** Эффективные фильтры по времени

## Использование

### Запуск системы

1. **Запуск всех сервисов:**
```bash
docker-compose up -d
```

2. **Проверка статуса:**
```bash
docker-compose ps
```

3. **Доступ к Superset:**
- URL: http://localhost:8088
- Логин: `rag_admin`
- Пароль: `rag_admin_password`

### Навигация по дашбордам

1. **Качество RAG системы:**
   - Анализ метрик качества поиска
   - Тренды релевантности и точности
   - Сравнение между тенантами

2. **Производительность системы:**
   - Мониторинг ресурсов
   - Время ответа API
   - Статус сервисов

3. **Использование системы:**
   - Активность пользователей
   - Популярные запросы
   - Статистика чат-сессий

### Настройка дашбордов

1. **Фильтры:**
   - По времени (последние 24 часа, неделя, месяц)
   - По тенантам
   - По сервисам

2. **Обновление:**
   - Автоматическое обновление каждые 5 минут
   - Ручное обновление по требованию
   - Настройка интервалов

3. **Экспорт:**
   - PNG изображения
   - CSV данные
   - PDF отчеты

## Мониторинг и алерты

### Интеграция с системой алертов

- Дашборды отображают активные алерты
- Визуализация критических метрик
- Уведомления о превышении порогов

### Ключевые метрики

1. **Качество:**
   - F1-мера > 0.8
   - Релевантность > 0.7
   - Время ответа < 2 секунд

2. **Производительность:**
   - CPU < 80%
   - Память < 85%
   - Диск < 90%

3. **Использование:**
   - Успешность запросов > 95%
   - Активные пользователи
   - Популярные функции

## Безопасность

### Аутентификация и авторизация

- JWT токены для API
- Роли и права доступа
- Аудит действий пользователей

### Защита данных

- Шифрование соединений
- Ограничение доступа
- Логирование действий

## Ограничения

1. **Зависимость от ClickHouse:** Требует работающий ClickHouse
2. **Ресурсы:** Superset потребляет память и CPU
3. **Данные:** Требует накопления метрик для анализа
4. **Сеть:** Требует стабильного соединения между сервисами

## Планы развития

1. **Дополнительные дашборды:**
   - Дашборд безопасности
   - Дашборд бизнес-метрик
   - Дашборд интеграций

2. **Расширенная аналитика:**
   - Машинное обучение для предсказаний
   - Аномалии и выбросы
   - Корреляционный анализ

3. **Интеграции:**
   - Slack уведомления
   - Email отчеты
   - API для внешних систем

4. **Кастомизация:**
   - Пользовательские виджеты
   - Темы оформления
   - Персональные дашборды

## Метрики успеха

- ✅ Настроен Superset с ClickHouse
- ✅ Созданы 3 специализированных дашборда
- ✅ Реализованы 15 различных чартов
- ✅ Настроена система пользователей и прав
- ✅ Автоматизирована инициализация
- ✅ Интегрированы все источники метрик
- ✅ Оптимизирована производительность
- ✅ Настроена безопасность

## Заключение

Этап 13 успешно реализует полноценную систему дашбордов для RAG платформы. Apache Superset обеспечивает:

- **Полную визуализацию** всех метрик системы
- **Интуитивные дашборды** для разных аспектов мониторинга
- **Гибкую настройку** и кастомизацию
- **Безопасный доступ** с системой ролей
- **Автоматическую инициализацию** и настройку

Система готова к использованию в продакшене и обеспечивает полный контроль над всеми аспектами работы RAG платформы через удобный веб-интерфейс.
