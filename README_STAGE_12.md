# Этап 12: Система мониторинга и алертов

## Обзор

Этап 12 реализует полноценную систему мониторинга производительности, качества поиска и алертов для RAG платформы. Система включает сбор метрик, анализ качества, мониторинг ресурсов и автоматические уведомления.

## Реализованные компоненты

### 1. Расширенная схема ClickHouse

**Файл:** `infra/db/clickhouse/init/00_schema.sql`

#### Новые таблицы:
- `system_metrics` - системные метрики производительности
- `search_quality_metrics` - метрики качества поиска
- `resource_usage_metrics` - метрики использования ресурсов
- `user_activity_metrics` - метрики пользовательской активности
- `alerts` - система алертов
- `api_metrics` - метрики API
- `embedding_metrics` - метрики эмбеддингов
- `vector_search_metrics` - метрики векторного поиска

#### Материализованные представления:
- `hourly_system_metrics` - почасовая агрегация системных метрик
- `daily_search_stats` - ежедневная статистика поиска
- `daily_error_stats` - ежедневная статистика ошибок

#### Индексы:
- Оптимизированные индексы для быстрого поиска по сервисам и тенантам

### 2. Сервис сбора метрик

**Файл:** `apps/api/src/services/metrics_collector.py`

#### Функциональность:
- **Сбор системных метрик:**
  - CPU использование (общее и по ядрам)
  - Память (общая, доступная, swap)
  - Диск (использование, свободное место)
  - Сеть (входящий/исходящий трафик)
  - Процессы (CPU, память, потоки)

- **Сбор метрик приложения:**
  - Соединения с базой данных
  - Кэш hit rate
  - Запросы эмбеддингов

- **Буферизация и оптимизация:**
  - Буферизация метрик для эффективной записи
  - Автоматический сброс буфера
  - Настраиваемый интервал сбора

### 3. Мониторинг качества поиска

**Файл:** `apps/api/src/services/quality_monitor.py`

#### Метрики качества:
- **Релевантность:** Jaccard similarity между запросом и результатами
- **Точность:** Процент релевантных результатов
- **Полнота:** Процент найденных релевантных документов
- **F1-мера:** Гармоническое среднее точности и полноты

#### Анализ качества ответов:
- **Связность:** Анализ длины и структуры предложений
- **Релевантность:** Соответствие длины ответа запросу
- **Полнота:** Наличие ключевых элементов ответа
- **Точность:** Наличие конкретных данных и терминов

#### Статистика и тренды:
- Агрегированная статистика за период
- Тренды качества по дням
- Анализ изменений качества

### 4. Мониторинг ресурсов

**Файл:** `apps/api/src/services/resource_monitor.py`

#### Мониторинг ресурсов:
- **CPU:** Использование, частота, загрузка по ядрам
- **Память:** Общая, доступная, swap
- **Диск:** Использование, IO операции, информация о разделах
- **Сеть:** Трафик, активные соединения, статистика интерфейсов
- **Процессы:** Топ процессов, информация о текущем процессе

#### Система алертов:
- **Пороговые значения:** Настраиваемые лимиты для каждого ресурса
- **Автоматические алерты:** При превышении порогов
- **Уровни серьезности:** warning, critical
- **Кулдауны:** Предотвращение спама алертов

### 5. Система алертов и уведомлений

**Файл:** `apps/api/src/services/alert_system.py`

#### Правила алертов:
- **Высокое использование CPU:** > 80%
- **Высокое использование памяти:** > 85%
- **Высокое использование диска:** > 90%
- **Высокий процент ошибок поиска:** > 10%
- **Медленные API ответы:** > 5 секунд
- **Высокий процент ошибок эмбеддингов:** > 5%

#### Каналы уведомлений:
- **Email:** SMTP уведомления с детальной информацией
- **Webhook:** HTTP POST запросы для интеграции
- **Slack:** Форматированные сообщения в Slack
- **Пользовательские обработчики:** Возможность добавления собственных каналов

#### Управление алертами:
- Подтверждение алертов
- Разрешение алертов
- История алертов
- Кулдауны для предотвращения спама

### 6. API эндпоинты мониторинга

**Файл:** `apps/api/src/routers/monitoring.py`

#### Эндпоинты:
- `GET /monitoring/system-metrics` - системные метрики
- `GET /monitoring/resource-usage` - использование ресурсов
- `GET /monitoring/resource-statistics` - статистика ресурсов
- `GET /monitoring/quality-metrics` - метрики качества
- `GET /monitoring/quality-trends` - тренды качества
- `POST /monitoring/search-quality` - запись метрик качества поиска
- `POST /monitoring/response-quality` - запись метрик качества ответов
- `GET /monitoring/alerts` - получение алертов
- `POST /monitoring/alerts/{alert_id}/acknowledge` - подтверждение алерта
- `POST /monitoring/alerts/{alert_id}/resolve` - разрешение алерта
- `GET /monitoring/health` - здоровье системы мониторинга
- `POST /monitoring/start-collection` - запуск сбора метрик
- `POST /monitoring/stop-collection` - остановка сбора метрик

## Технические детали

### Зависимости

**Файл:** `apps/api/requirements.txt`

Добавлены новые зависимости:
```
clickhouse-connect==0.6.23  # Подключение к ClickHouse
psutil==5.9.6               # Системные метрики
aiohttp==3.9.1              # HTTP клиент для webhook
```

### Конфигурация

**Файл:** `apps/api/src/settings/config.py`

Добавлены настройки:
- ClickHouse подключение
- SMTP для email уведомлений
- Slack webhook для уведомлений

### Интеграция

**Файл:** `apps/api/src/main.py`

- Подключен роутер мониторинга
- Добавлены эндпоинты для мониторинга

## Архитектура системы

### Сбор метрик
```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   Система       │───▶│  MetricsCollector│───▶│   ClickHouse    │
│   (CPU, RAM)    │    │                  │    │                 │
└─────────────────┘    └──────────────────┘    └─────────────────┘
```

### Мониторинг качества
```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   Поиск/Ответы  │───▶│ QualityMonitor   │───▶│   ClickHouse    │
│                 │    │                  │    │                 │
└─────────────────┘    └──────────────────┘    └─────────────────┘
```

### Система алертов
```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   ClickHouse    │───▶│   AlertSystem    │───▶│   Уведомления   │
│   (Метрики)     │    │   (Правила)      │    │ (Email/Slack)   │
└─────────────────┘    └──────────────────┘    └─────────────────┘
```

## Использование

### Запуск мониторинга

1. **Автоматический запуск:**
```bash
# Запуск сбора метрик
curl -X POST "http://localhost:8080/api/v1/monitoring/start-collection?service=api" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

2. **Проверка здоровья:**
```bash
curl "http://localhost:8080/api/v1/monitoring/health"
```

### Получение метрик

1. **Системные метрики:**
```bash
curl "http://localhost:8080/api/v1/monitoring/system-metrics?service=api" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

2. **Использование ресурсов:**
```bash
curl "http://localhost:8080/api/v1/monitoring/resource-usage?service=api" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

3. **Метрики качества:**
```bash
curl "http://localhost:8080/api/v1/monitoring/quality-metrics?tenant_id=tenant1&days=7" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### Управление алертами

1. **Получение активных алертов:**
```bash
curl "http://localhost:8080/api/v1/monitoring/alerts?status=active" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

2. **Подтверждение алерта:**
```bash
curl -X POST "http://localhost:8080/api/v1/monitoring/alerts/alert123/acknowledge" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"acknowledged_by": "admin"}'
```

## Настройка алертов

### Email уведомления

Настройте переменные окружения:
```bash
SMTP_SERVER=smtp.gmail.com
SMTP_PORT=587
SMTP_USERNAME=your-email@gmail.com
SMTP_PASSWORD=your-password
SMTP_FROM_EMAIL=alerts@your-domain.com
ALERT_EMAILS=admin@your-domain.com,ops@your-domain.com
```

### Slack уведомления

Настройте Slack webhook:
```bash
SLACK_WEBHOOK_URL=https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK
SLACK_CHANNEL=#alerts
```

## Мониторинг и дашборды

### ClickHouse запросы

1. **Топ сервисов по использованию CPU:**
```sql
SELECT 
    service,
    avg(cpu_usage_percent) as avg_cpu
FROM rag.resource_usage_metrics
WHERE timestamp >= now() - INTERVAL 1 HOUR
GROUP BY service
ORDER BY avg_cpu DESC
```

2. **Тренды качества поиска:**
```sql
SELECT 
    toDate(timestamp) as date,
    avg(relevance_score) as avg_relevance,
    avg(f1_score) as avg_f1
FROM rag.search_quality_metrics
WHERE timestamp >= now() - INTERVAL 30 DAY
GROUP BY date
ORDER BY date
```

3. **Активные алерты:**
```sql
SELECT 
    alert_type,
    severity,
    service,
    message,
    timestamp
FROM rag.alerts
WHERE status = 'active'
ORDER BY timestamp DESC
```

## Производительность

### Оптимизации:
- **Буферизация:** Метрики собираются в буфер и записываются батчами
- **Материализованные представления:** Автоматическая агрегация данных
- **Индексы:** Оптимизированные индексы для быстрого поиска
- **Кулдауны:** Предотвращение спама алертов

### Масштабируемость:
- **Горизонтальное масштабирование:** Поддержка множества сервисов
- **Партиционирование:** Данные разделены по времени
- **Сжатие:** ClickHouse автоматически сжимает данные

## Безопасность

### Аутентификация:
- Все эндпоинты требуют JWT токен
- Проверка прав доступа к метрикам

### Конфиденциальность:
- Метрики не содержат персональных данных
- Агрегированные данные для анализа

## Ограничения

1. **Зависимость от ClickHouse:** Требует работающий ClickHouse
2. **Ресурсы:** Сбор метрик потребляет системные ресурсы
3. **Хранение:** Метрики накапливаются и требуют места
4. **Сетевые зависимости:** Email/Slack уведомления требуют интернет

## Планы развития

1. **Дашборды:** Веб-интерфейс для просмотра метрик
2. **ML алерты:** Машинное обучение для предсказания проблем
3. **Интеграции:** Prometheus, Grafana, ELK Stack
4. **Автоматизация:** Автоматическое масштабирование на основе метрик
5. **Аналитика:** Продвинутая аналитика использования

## Метрики успеха

- ✅ Создана расширенная схема ClickHouse
- ✅ Реализован сбор системных метрик
- ✅ Добавлен мониторинг качества поиска
- ✅ Создана система мониторинга ресурсов
- ✅ Реализована система алертов и уведомлений
- ✅ Добавлены API эндпоинты для мониторинга
- ✅ Настроена интеграция с email и Slack
- ✅ Оптимизирована производительность сбора метрик

## Заключение

Этап 12 успешно реализует полноценную систему мониторинга для RAG платформы. Система обеспечивает:

- **Полный контроль** над производительностью системы
- **Качественный мониторинг** поиска и ответов
- **Проактивные алерты** для предотвращения проблем
- **Детальную аналитику** использования ресурсов
- **Гибкую настройку** каналов уведомлений

Система готова к использованию в продакшене и может быть легко расширена для дополнительных метрик и интеграций.
