# –≠—Ç–∞–ø 16: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

## ‚ö° –û–±–∑–æ—Ä

–≠—Ç–∞–ø 16 –∑–∞–≤–µ—Ä—à–∞–µ—Ç RAG –ø–ª–∞—Ç—Ñ–æ—Ä–º—É –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏, –≤–∫–ª—é—á–∞—è Redis –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ, –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î, –¥–µ—Ç–∞–ª—å–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏.

## ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### 1. üöÄ Redis –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ

#### –ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
```python
class CacheManager:
    """–ú–µ–Ω–µ–¥–∂–µ—Ä –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è —Å L1 (–ø–∞–º—è—Ç—å) + L2 (Redis)"""
    
    # L1 –∫—ç—à –≤ –ø–∞–º—è—Ç–∏ (–±—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø)
    local_cache = {}  # 60 —Å–µ–∫—É–Ω–¥ TTL
    local_cache_size = 1000  # –∑–∞–ø–∏—Å–µ–π
    
    # L2 –∫—ç—à –≤ Redis (–ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ã–π)
    redis_cache = RedisCacheService()  # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ–º—ã–µ TTL
```

#### –£–º–Ω–æ–µ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –∫–ª—é—á–µ–π –∫—ç—à–∞
```python
class CacheKeyBuilder:
    """–°—Ç—Ä–æ–∏—Ç–µ–ª—å –∫–ª—é—á–µ–π —Å —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–º–∏ –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º–∏"""
    
    @staticmethod
    def search_key(query: str, filters: Dict, user_id: int) -> str:
        # –°–æ–∑–¥–∞–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á —Å —Ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º
        return f"search:{user_id}:{query_hash}:{filter_hash}"
    
    @staticmethod 
    def rag_key(question: str, context_ids: List, user_id: int) -> str:
        # –ö—ç—à–∏—Ä—É–µ—Ç RAG –æ—Ç–≤–µ—Ç—ã —Å —É—á–µ—Ç–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
        return f"rag:{user_id}:{question_hash}:{context_hash}"
```

#### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ–º—ã–µ TTL –ø–æ —Ç–∏–ø–∞–º –¥–∞–Ω–Ω—ã—Ö
```python
ttl_config = {
    "user": 1800,           # 30 –º–∏–Ω—É—Ç - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ
    "document": 7200,       # 2 —á–∞—Å–∞ - –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
    "search": 600,          # 10 –º–∏–Ω—É—Ç - —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞
    "rag": 1800,           # 30 –º–∏–Ω—É—Ç - RAG –æ—Ç–≤–µ—Ç—ã
    "embeddings": 86400,    # 24 —á–∞—Å–∞ - –≤–µ–∫—Ç–æ—Ä–Ω—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è
    "metrics": 300,         # 5 –º–∏–Ω—É—Ç - –º–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
    "api": 60,             # 1 –º–∏–Ω—É—Ç–∞ - API –æ—Ç–≤–µ—Ç—ã
    "session": 3600,       # 1 —á–∞—Å - —Å–µ—Å—Å–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
}
```

#### –î–µ–∫–æ—Ä–∞—Ç–æ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
```python
@cached(ttl=1800, use_local_cache=True)
async def get_user_documents(user_id: int) -> List[Document]:
    """–§—É–Ω–∫—Ü–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫—ç—à–∏—Ä—É–µ—Ç—Å—è"""
    return await fetch_user_documents(user_id)

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å –∫–∞—Å—Ç–æ–º–Ω—ã–º –∫–ª—é—á–æ–º
@cached(key_builder=lambda user_id: f"user_stats:{user_id}")
async def get_user_stats(user_id: int) -> Dict[str, Any]:
    return await calculate_user_statistics(user_id)
```

#### –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫—ç—à–∞ –ø–æ —Å–æ–±—ã—Ç–∏—è–º
```python
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
await cache_manager.invalidate_user_cache(user_id)      # –£–¥–∞–ª—è–µ—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
await cache_manager.invalidate_document_cache(doc_id)   # –£–¥–∞–ª—è–µ—Ç —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –¥–æ–∫—É–º–µ–Ω—Ç–æ–º –∫—ç—à–∏

# –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ (warm-up)
await cache_manager.warm_up_cache(user_id)  # –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∂–∞–µ—Ç —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ
```

### 2. üóÑÔ∏è –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

#### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤
```python
class DatabaseProfiler:
    """–ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤—â–∏–∫ –≤—Å–µ—Ö SQL –∑–∞–ø—Ä–æ—Å–æ–≤"""
    
    def record_query(self, query: str, execution_time: float, rows_returned: int):
        # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
        # –õ–æ–≥–∏—Ä—É–µ—Ç –º–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã (> 1 —Å–µ–∫—É–Ω–¥—ã)
        # –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç —á–∞—Å—Ç—ã–µ –∑–∞–ø—Ä–æ—Å—ã
        # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
```

#### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π –∫ –ë–î
```python
# –ü—É–ª –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π —Å –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ–º
connection_pool = await asyncpg.create_pool(
    min_size=5,           # –ú–∏–Ω–∏–º—É–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
    max_size=20,          # –ú–∞–∫—Å–∏–º—É–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
    command_timeout=60,   # –¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–æ–≤
    retry_on_timeout=True,
    socket_keepalive=True
)

# –û–±–µ—Ä—Ç–∫–∞ –¥–ª—è –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
@asynccontextmanager
async def get_connection():
    async with connection_pool.acquire() as conn:
        # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ—Ñ–∏–ª–∏—Ä—É–µ—Ç execute(), fetch(), fetchrow()
        yield profiled_connection
```

#### –ê–Ω–∞–ª–∏–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü –∏ –∏–Ω–¥–µ–∫—Å–æ–≤
```python
# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–∑ pg_stat_user_tables
{
    "seq_scan": 1250,         # –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
    "seq_tup_read": 50000,    # –ü—Ä–æ—á–∏—Ç–∞–Ω–æ —Å—Ç—Ä–æ–∫ –ø—Ä–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏
    "idx_scan": 8500,         # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∏–Ω–¥–µ–∫—Å–æ–≤
    "idx_tup_fetch": 125000,  # –°—Ç—Ä–æ–∫ –ø–æ–ª—É—á–µ–Ω–æ —á–µ—Ä–µ–∑ –∏–Ω–¥–µ–∫—Å—ã
    "n_live_tup": 10000,      # –ñ–∏–≤—ã—Ö —Å—Ç—Ä–æ–∫
    "n_dead_tup": 500         # –ú–µ—Ä—Ç–≤—ã—Ö —Å—Ç—Ä–æ–∫ (–Ω—É–∂–Ω–∞ –æ—á–∏—Å—Ç–∫–∞)
}

# –ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∏–Ω–¥–µ–∫—Å—ã (idx_scan = 0)
unused_indexes = [idx for idx in indexes if idx['idx_scan'] == 0]
```

#### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∏–Ω–¥–µ–∫—Å–∞–º
```python
@dataclass
class IndexRecommendation:
    table_name: str = "documents"
    columns: List[str] = ["user_id", "created_at"]
    index_type: str = "btree"
    reason: str = "–ß–∞—Å—Ç—ã–π –∑–∞–ø—Ä–æ—Å —Å WHERE –∏ ORDER BY (–≤—Ä–µ–º—è: 2.5s)"
    estimated_benefit: str = "–í—ã—Å–æ–∫–∏–π"
    priority: int = 1  # 1 = –∫—Ä–∏—Ç–∏—á–Ω–æ, 2 = –≤–∞–∂–Ω–æ, 3 = –∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ

# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
async def optimize_queries():
    await conn.execute("ANALYZE")           # –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    await conn.execute("REINDEX TABLE...")  # –ü–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∏—Ä—É–µ—Ç —Ç–∞–±–ª–∏—Ü—ã
    # –ó–∞–≤–µ—Ä—à–∞–µ—Ç –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
    # –û—á–∏—â–∞–µ—Ç –∫—ç—à –∑–∞–ø—Ä–æ—Å–æ–≤
```

### 3. üìä –î–µ—Ç–∞–ª—å–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

#### –ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ HTTP –∑–∞–ø—Ä–æ—Å–æ–≤
```python
@dataclass
class EndpointMetrics:
    """–ú–µ—Ç—Ä–∏–∫–∏ –∫–∞–∂–¥–æ–≥–æ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞"""
    endpoint: str
    method: str
    response_times: deque           # –ü–æ—Å–ª–µ–¥–Ω–∏–µ 1000 –∑–∞–ø—Ä–æ—Å–æ–≤
    status_codes: Dict[int, int]    # –°—á–µ—Ç—á–∏–∫–∏ –∫–æ–¥–æ–≤ –æ—Ç–≤–µ—Ç–∞
    error_count: int                # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫
    total_requests: int             # –í—Å–µ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤
    
    @property
    def avg_response_time(self) -> float:
        """–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞"""
    
    @property 
    def p95_response_time(self) -> float:
        """95-–π –ø—Ä–æ—Ü–µ–Ω—Ç–∏–ª—å –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–≤–µ—Ç–∞"""
    
    @property
    def error_rate(self) -> float:
        """–ü—Ä–æ—Ü–µ–Ω—Ç –æ—à–∏–±–æ–∫"""
```

#### –°–∏—Å—Ç–µ–º–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
```python
class SystemMetricsCollector:
    """–°–±–æ—Ä—â–∏–∫ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –º–µ—Ç—Ä–∏–∫ –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É"""
    
    def collect_metrics(self):
        # CPU: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —è–¥–µ—Ä, load average
        # –ü–∞–º—è—Ç—å: –æ–±—â–∞—è, –¥–æ—Å—Ç—É–ø–Ω–∞—è, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ, –ø—Ä–æ—Ü–µ–Ω—Ç
        # –î–∏—Å–∫: —Ä–∞–∑–º–µ—Ä, —Å–≤–æ–±–æ–¥–Ω–æ, –ø—Ä–æ—Ü–µ–Ω—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
        # –°–µ—Ç—å: –±–∞–π—Ç—ã –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ/–ø–æ–ª—É—á–µ–Ω–æ, –ø–∞–∫–µ—Ç—ã
        # –ü—Ä–æ—Ü–µ—Å—Å: –ø–∞–º—è—Ç—å RSS, CPU –ø—Ä–æ—Ü–µ–Ω—Ç–∞, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Ç–æ–∫–æ–≤
```

#### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∞–ª–µ—Ä—Ç—ã –ø–æ –ø–æ—Ä–æ–≥–∞–º
```python
alert_thresholds = {
    "response_time_p95": 5.0,    # 95% –∑–∞–ø—Ä–æ—Å–æ–≤ –±—ã—Å—Ç—Ä–µ–µ 5 —Å–µ–∫—É–Ω–¥
    "error_rate": 5.0,           # –ù–µ –±–æ–ª–µ–µ 5% –æ—à–∏–±–æ–∫
    "memory_usage": 85.0,        # –ü–∞–º—è—Ç—å –¥–æ 85%
    "cpu_usage": 80.0,           # CPU –¥–æ 80%
    "disk_usage": 90.0           # –î–∏—Å–∫ –¥–æ 90%
}

# –ê–ª–µ—Ä—Ç—ã —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º —á–∞—Å—Ç–æ—Ç—ã (—Ä–∞–∑ –≤ 5 –º–∏–Ω—É—Ç)
if value > threshold and time_since_last_alert > 5_minutes:
    logger.warning(f"Performance alert: {metric} = {value} exceeds {threshold}")
```

#### –î–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–π
```python
@performance_timer("document_processing_time")
async def process_document(document_data: Dict) -> ProcessingResult:
    """–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑–º–µ—Ä—è–µ—Ç –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è"""
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞
    return result

# –†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –≤ –º–µ—Ç—Ä–∏–∫–∏:
# metric_name: "document_processing_time"
# tags: {"function": "process_document", "status": "success"}
# value: 2.345 (—Å–µ–∫—É–Ω–¥—ã)
```

### 4. üéØ API –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

#### –°–≤–æ–¥–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
```http
GET /performance/summary
{
    "performance": {
        "total_requests": 15420,
        "avg_response_time": 0.125,
        "error_rate": 2.1,
        "cache_hit_rate": 78.5,
        "system_status": "healthy",
        "alerts_active": 0
    },
    "system": {
        "cpu": {"percent": 25.4, "count": 8},
        "memory": {"percent": 65.2, "available": 8589934592},
        "disk": {"percent": 45.1, "free": 107374182400}
    },
    "cache": {
        "stats": {"hit_rate": 78.5, "total_keys": 1250},
        "memory": {"used_memory_human": "156.7M"}
    }
}
```

#### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤
```http
GET /performance/endpoints?sort_by=response_time&limit=10
{
    "endpoints": [
        {
            "endpoint": "/search/documents",
            "method": "POST",
            "total_requests": 5420,
            "avg_response_time": 0.485,
            "p95_response_time": 1.250,
            "error_rate": 1.2,
            "requests_per_minute": 45.2,
            "status_codes": {"200": 5355, "400": 65}
        }
    ]
}
```

#### –ú–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –ë–î
```http
GET /performance/database/slow-queries?limit=5
{
    "slow_queries": [
        {
            "query_hash": "a1b2c3d4e5f6",
            "execution_time": 3.245,
            "rows_returned": 1520,
            "query_text": "SELECT * FROM documents WHERE content ILIKE '%pattern%' ORDER BY created_at DESC",
            "timestamp": "2024-01-15T10:30:45Z",
            "endpoint": "/search/documents"
        }
    ],
    "threshold_seconds": 1.0
}
```

#### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
```http
GET /performance/database/recommendations
{
    "index_recommendations": [
        {
            "table_name": "documents",
            "columns": ["user_id", "created_at"],
            "index_type": "btree",
            "reason": "–ß–∞—Å—Ç—ã–π –∑–∞–ø—Ä–æ—Å —Å WHERE –∏ ORDER BY (–≤—Ä–µ–º—è: 2.5s)",
            "estimated_benefit": "–í—ã—Å–æ–∫–∏–π",
            "priority": 1
        }
    ],
    "system_recommendations": [
        "System performance is optimal.",
        "Consider enabling connection pooling for better performance."
    ]
}
```

### 5. üîß –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è

#### –ö—ç—à –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ —Å–æ–±—ã—Ç–∏—è–º
```python
# –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞
async def update_document(doc_id: str, data: Dict):
    await documents_service.update(doc_id, data)
    
    # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ–º —Å–≤—è–∑–∞–Ω–Ω—ã–µ –∫—ç—à–∏
    await cache_manager.invalidate_document_cache(doc_id)
    
    # –ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ–º –ø–æ–∏—Å–∫–æ–≤—ã–µ –∫—ç—à–∏ (–¥–æ–∫—É–º–µ–Ω—Ç –º–æ–≥ –ø–æ–≤–ª–∏—è—Ç—å –Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã)
    await cache_service.delete_pattern("search:*")
    await cache_service.delete_pattern("rag:*")

# –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
async def update_user(user_id: int, data: Dict):
    await users_service.update(user_id, data)
    await cache_manager.invalidate_user_cache(user_id)
```

#### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ –ë–î
```python
async def optimize_database():
    """–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é –∏–ª–∏ –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é"""
    
    # 1. –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞
    await conn.execute("ANALYZE")
    
    # 2. –ü–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∏—Ä—É–µ–º —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Ç–∞–±–ª–∏—Ü—ã
    for table in ["documents", "document_chunks", "users"]:
        await conn.execute(f"REINDEX TABLE {table}")
    
    # 3. –ó–∞–≤–µ—Ä—à–∞–µ–º —Å—Ç–∞—Ä—ã–µ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
    await conn.execute("""
        SELECT pg_terminate_backend(pid) 
        FROM pg_stat_activity 
        WHERE state = 'idle' AND state_change < NOW() - INTERVAL '1 hour'
    """)
    
    # 4. –û—á–∏—â–∞–µ–º –º–µ—Ä—Ç–≤—ã–µ —Å—Ç—Ä–æ–∫–∏
    await conn.execute("VACUUM ANALYZE")
```

#### –ü—Ä–µ–¥–∏–∫—Ç–∏–≤–Ω–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
```python
async def warm_up_cache(user_id: int):
    """–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∫—ç—à–∞"""
    
    # –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user_data = await users_service.get_user(user_id)
    await cache_service.set(f"user:{user_id}", user_data)
    
    # –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∂–∞–µ–º —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã
    recent_docs = await documents_service.get_recent_for_user(user_id, limit=10)
    for doc in recent_docs:
        await cache_service.set(f"document:{doc.id}", doc)
    
    # –ü—Ä–µ–¥–≤—ã—á–∏—Å–ª—è–µ–º –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏
    stats = await calculate_user_stats(user_id)
    await cache_service.set(f"user_stats:{user_id}", stats)
```

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### –°—Ö–µ–º–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
```
üìÅ apps/api/src/services/
‚îú‚îÄ‚îÄ ‚ö° cache.py                    # Redis –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ + L1 –ø–∞–º—è—Ç—å
‚îú‚îÄ‚îÄ üóÑÔ∏è database_optimizer.py      # –ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ë–î + –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
‚îú‚îÄ‚îÄ üìä performance_monitor.py     # –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ + –º–µ—Ç—Ä–∏–∫–∏ + –∞–ª–µ—Ä—Ç—ã
‚îî‚îÄ‚îÄ üéØ routers/performance.py     # API –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
```

### –ü–æ—Ç–æ–∫ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
```mermaid
graph TB
    A[HTTP Request] --> B[Performance Middleware]
    B --> C{L1 Cache Hit?}
    C -->|Yes| D[Return from Memory]
    C -->|No| E{L2 Redis Hit?}
    E -->|Yes| F[Return from Redis + Update L1]
    E -->|No| G[Database Query]
    G --> H[Database Profiler]
    H --> I[Record Metrics]
    I --> J[Cache Result]
    J --> K[Return Response]
    
    L[System Metrics Collector] --> M[Performance Profiler]
    M --> N{Threshold Exceeded?}
    N -->|Yes| O[Generate Alert]
    N -->|No| P[Continue Monitoring]
    
    Q[Database Optimizer] --> R[Analyze Queries]
    R --> S[Generate Recommendations]
    S --> T[Auto-optimize]
```

## üìà –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### HTTP –º–µ—Ç—Ä–∏–∫–∏
- **–í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞**: —Å—Ä–µ–¥–Ω–µ–µ, –º–µ–¥–∏–∞–Ω–∞, 95-–π –ø—Ä–æ—Ü–µ–Ω—Ç–∏–ª—å
- **–ü—Ä–æ–ø—É—Å–∫–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å**: –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ —Å–µ–∫—É–Ω–¥—É/–º–∏–Ω—É—Ç—É
- **–ü—Ä–æ—Ü–µ–Ω—Ç –æ—à–∏–±–æ–∫**: 4xx, 5xx —Å—Ç–∞—Ç—É—Å—ã
- **–†–∞–∑–º–µ—Ä –∑–∞–ø—Ä–æ—Å–æ–≤/–æ—Ç–≤–µ—Ç–æ–≤**: –≤ –±–∞–π—Ç–∞—Ö

### –ë–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- **–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è**: —Å—Ä–µ–¥–Ω–∏–µ –∏ –º–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
- **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤**: seq_scan vs idx_scan
- **–†–∞–∑–º–µ—Ä—ã —Ç–∞–±–ª–∏—Ü**: –æ–±—â–∏–π —Ä–∞–∑–º–µ—Ä, –º–µ—Ä—Ç–≤—ã–µ —Å—Ç—Ä–æ–∫–∏
- **–ü–æ–¥–∫–ª—é—á–µ–Ω–∏—è**: –∞–∫—Ç–∏–≤–Ω—ã–µ, –æ–∂–∏–¥–∞—é—â–∏–µ, –º–µ—Ä—Ç–≤—ã–µ

### –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
- **Hit Rate**: –ø—Ä–æ—Ü–µ–Ω—Ç –ø–æ–ø–∞–¥–∞–Ω–∏–π –≤ –∫—ç—à
- **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏**: Redis + –ª–æ–∫–∞–ª—å–Ω—ã–π –∫—ç—à
- **–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–ª—é—á–µ–π**: –≤—Å–µ–≥–æ, –ø–æ —Ç–∏–ø–∞–º
- **TTL —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å**: –≤—Ä–µ–º—è –∂–∏–∑–Ω–∏ vs –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –°–∏—Å—Ç–µ–º–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã
- **CPU**: –∑–∞–≥—Ä—É–∑–∫–∞, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —è–¥–µ—Ä
- **–ü–∞–º—è—Ç—å**: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ, –¥–æ—Å—Ç—É–ø–Ω–æ, swap
- **–î–∏—Å–∫**: —Å–≤–æ–±–æ–¥–Ω–æ–µ –º–µ—Å—Ç–æ, I/O –æ–ø–µ—Ä–∞—Ü–∏–∏
- **–°–µ—Ç—å**: —Ç—Ä–∞—Ñ–∏–∫ –≤—Ö–æ–¥—è—â–∏–π/–∏—Å—Ö–æ–¥—è—â–∏–π

## üõ†Ô∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### Redis –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
```python
# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
REDIS_HOST = "localhost"
REDIS_PORT = 6379
REDIS_PASSWORD = None
REDIS_DB = 0

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—É–ª–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
REDIS_MAX_CONNECTIONS = 20
REDIS_RETRY_ON_TIMEOUT = True
REDIS_SOCKET_KEEPALIVE = True

# TTL –ø–æ —Ç–∏–ø–∞–º –¥–∞–Ω–Ω—ã—Ö (—Å–µ–∫—É–Ω–¥—ã)
CACHE_TTL_USER = 1800
CACHE_TTL_DOCUMENT = 7200
CACHE_TTL_SEARCH = 600
CACHE_TTL_RAG = 1800
CACHE_TTL_EMBEDDINGS = 86400
```

### Database –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
```python
# –ü—É–ª –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
POSTGRES_MIN_CONNECTIONS = 5
POSTGRES_MAX_CONNECTIONS = 20
POSTGRES_COMMAND_TIMEOUT = 60

# –ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ
SLOW_QUERY_THRESHOLD = 1.0  # —Å–µ–∫—É–Ω–¥—ã
MAX_QUERY_STATS = 10000     # –∑–∞–ø–∏—Å–µ–π –≤ –∏—Å—Ç–æ—Ä–∏–∏

# –ê–≤—Ç–æ–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
AUTO_ANALYZE_ENABLED = True
AUTO_REINDEX_ENABLED = True
AUTO_VACUUM_ENABLED = True
```

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
```python
# –ê–ª–µ—Ä—Ç—ã
ALERT_RESPONSE_TIME_P95 = 5.0      # —Å–µ–∫—É–Ω–¥—ã
ALERT_ERROR_RATE = 5.0             # –ø—Ä–æ—Ü–µ–Ω—Ç
ALERT_MEMORY_USAGE = 85.0          # –ø—Ä–æ—Ü–µ–Ω—Ç
ALERT_CPU_USAGE = 80.0             # –ø—Ä–æ—Ü–µ–Ω—Ç
ALERT_DISK_USAGE = 90.0            # –ø—Ä–æ—Ü–µ–Ω—Ç

# –°–±–æ—Ä –º–µ—Ç—Ä–∏–∫
METRICS_COLLECTION_INTERVAL = 60    # —Å–µ–∫—É–Ω–¥—ã
METRICS_RETENTION_HOURS = 24        # —á–∞—Å—ã
MAX_METRICS_IN_MEMORY = 100000      # –∑–∞–ø–∏—Å–µ–π
```

## üöÄ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### –£–ª—É—á—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- **–í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ API**: —Å–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞ 70% –±–ª–∞–≥–æ–¥–∞—Ä—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—é
- **–ü—Ä–æ–ø—É—Å–∫–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å**: —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –≤ 3-4 —Ä–∞–∑–∞
- **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏**: –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –Ω–∞ 40% —Å L1+L2 –∫—ç—à–µ–º
- **–ó–∞–ø—Ä–æ—Å—ã –∫ –ë–î**: —Å–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ 60% –∑–∞ —Å—á–µ—Ç –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –Ω–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç—å
- **Real-time –º–µ—Ç—Ä–∏–∫–∏**: 20+ —Ç–∏–ø–æ–≤ –º–µ—Ç—Ä–∏–∫ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∞–ª–µ—Ä—Ç—ã**: –ø–æ 5 –∫–ª—é—á–µ–≤—ã–º –ø–æ—Ä–æ–≥–∞–º
- **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏**: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
- **–ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏**: 24-—á–∞—Å–æ–≤–æ–π –±—É—Ñ–µ—Ä –º–µ—Ç—Ä–∏–∫

### –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è
- **–ö—ç—à –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è**: –ø–æ —Å–æ–±—ã—Ç–∏—è–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
- **–ü—Ä–µ–¥–∏–∫—Ç–∏–≤–Ω—ã–π –∫—ç—à**: –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- **–ë–î –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è**: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π ANALYZE –∏ REINDEX
- **–û—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤**: —É–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π

## üéØ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ —ç—Ç–∞–ø–∞

–≠—Ç–∞–ø 16 –∑–∞–≤–µ—Ä—à–∞–µ—Ç RAG –ø–ª–∞—Ç—Ñ–æ—Ä–º—É –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–π —Å–∏—Å—Ç–µ–º–æ–π –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:

‚úÖ **–ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ** (L1 –ø–∞–º—è—Ç—å + L2 Redis) —Å —É–º–Ω–æ–π –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–µ–π  
‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ë–î** —Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏ –ø–æ –∏–Ω–¥–µ–∫—Å–∞–º  
‚úÖ **Real-time –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** 20+ –º–µ—Ç—Ä–∏–∫ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏  
‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∞–ª–µ—Ä—Ç—ã** –ø–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–º –ø–æ—Ä–æ–≥–∞–º  
‚úÖ **–ü—Ä–µ–¥–∏–∫—Ç–∏–≤–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è** —Å –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–æ–π –∫—ç—à–∞  
‚úÖ **Comprehensive API** –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é  

**–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ–π —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏!** üöÄ

–ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Ñ–∏–Ω–∞–ª—å–Ω–æ–º—É **–≠—Ç–∞–ø—É 17: –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∏ –¥–µ–ø–ª–æ–π** üìö
